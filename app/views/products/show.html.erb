<div class="container">
  <% if params[:sort_by] %>
    <div class="row">
      <div class="col-8 my-auto pr-0 align-middle">
        <h3 class="text-dark my-auto"><%= params[:sort_by].split('_').join(' ').capitalize %> products</h3>
      </div>
      <div class="col pl-1 my-auto align-middle">
        <div class="dropdown my-2 text-right">
          <a class="btn btn-secondary dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Sort By
          </a>
          <div class="dropdown-menu dropdown-menu-right text-center" aria-labelledby="dropdownMenuLink">
            <%=  link_to (product_path + '?sort_by=most_related') do %>
              <span class="dropdown-item">Most related</span>
            <% end %>
            <%=  link_to (product_path + '?sort_by=most_favorite') do %>
              <span class="dropdown-item">Most favorite</span>
            <% end %>
            <%=  link_to (product_path + '?sort_by=top_rating') do %>
              <span class="dropdown-item">Top rating</span>
            <% end %>
            <%=  link_to (product_path + '?sort_by=oldest') do %>
              <span class="dropdown-item">Oldest</span>
            <% end %>
            <%=  link_to (product_path + '?sort_by=newest') do %>
              <span class="dropdown-item">Newest</span>
            <% end %>
          </div>
        </div>
      </div>
    </div>
    <% @products.each do |product| %>
      <% image_url = product.photo.attached? ? cl_image_path(product.photo.key) : '' %>
      <% days_ago = (Date.today - Date.new(product.created_at.year, product.created_at.month, product.created_at.day)).to_i %>
      <% reviews = product.reviews %>
      <% rating = reviews.count.positive? ? (reviews.map(&:rating).sum / reviews.count).round(2) : '-' %>
      <div class="my-1">
        <% product_favorited = false %>
        <% if current_user && product %>
          <% product_favorited = current_user.favorited?(product) %>
        <% end %>
        <%= link_to product_path(product) do %>
          <%= render 'shared/user_history_card', product: product, product_favorited: product_favorited, img_url: image_url, product_name: product.name, price:"⭐ #{rating}", scanned_time: '' %>
        <% end %>
      </div>
    <% end %>
  <% elsif params[:product_id].nil? %>
    <!-- Product info card -->
    <%= render 'shared/product_info' , product_name: @product.name, bg_img_url:@product.photo.attached? ? cl_image_path(@product.photo.key , height: 300, width: 400, crop: :fill) : image_path("https://dummyimage.com/300x300/fff/000&text=X"), rating:"4.7", company_name: @product.company_name, price: "¥100", ingredients: @product.ingredients, size: @product.size%>
    <!-- review_card -->
    <!-- Button trigger modal -->

    <%= render 'shared/modal_form' %>

    <% review_count = Product.find(params[:id]).reviews.count %>
    <% review_first =  Product.find(params[:id]).reviews.first%>
    <% user = Review.find(review_first.user_id).user %>
    <!-- small box before toggling -->
      <div class="toggling2">
        <div class="row">
          <div class="col-10">
            <h5 class="ml-3">Reviews <span class="text-muted"><%= review_count %></span></h5>
          </div>
          <div class="col-2">
            <i class="fas fa-chevron-down toggling"></i>
          </div>

        </div>

        <%= render 'shared/review_card_no_click', bg_img_url:user.photo.attached? ? cl_image_path(user.photo.key , height: 300, width: 400, crop: :fill) : image_path("https://dummyimage.com/300x300/fff/000&text=X"), review: review_first.comment %>
      </div>
    <!-- Box when toggled -->
    <div class="toggling3">
      <div class="title-card-product d-block">
        <div class="card-product-infos">
          <div class="row">
            <div class="col-10">
              <h5><strong>Reviews</strong> <span class="text-muted"><%= review_count %></span> </h5>
            </div>
            <div class="col-2">
              <i class="fas fa-chevron-up toggling4"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="title-card-product2">
        <div class="card-product-infos">
          <span style = "font-size: 12px">Remember to keep comments respectful and to follow our <a href="#">Community Guidelines</a></span>
        </div>
      </div>
      <div class ="comment-box" data-toggle="modal" data-target="#createReview">
        <%= render 'shared/review_card_no_click', bg_img_url:user.photo.attached? ? cl_image_path(current_user.photo.key , height: 300, width: 400, crop: :fill) : image_path("https://dummyimage.com/300x300/fff/000&text=X"), review: "Add a public comment..." %>
      </div>
      <% Product.find(params[:id]).reviews.each do |review| %>
        <% user = Review.find(review.id).user %>
        <%= render 'shared/review_card', bg_img_url:user.photo.attached? ? cl_image_path(user.photo.key , height: 300, width: 400, crop: :fill) : image_path("https://dummyimage.com/300x300/fff/000&text=X"), img_url: 'https://raw.githubusercontent.com/lewagon/fullstack-images/master/uikit/skateboard.jpg' , username: user.display_name, review:review.comment, rating:review.rating%>
      <% end %>
    <%# <% end %>
    </div>
    <script>
    document.querySelector(".toggling")
      .addEventListener("click", (event) => {
        document.querySelector(".toggling2").classList.toggle("active");
        document.querySelector(".toggling3").classList.toggle("active");
      });
    document.querySelector(".toggling4")
      .addEventListener("click", (event) => {
        document.querySelector(".toggling2").classList.toggle("active");
        document.querySelector(".toggling3").classList.toggle("active");
      });
    </script>
    <!-- product_card -->
    <div class="row" style="position: relative;">
      <div class="col-9">
        <h4 class="mb-1">Recommended for you</h4>
      </div>
      <div class="col">
        <%=  link_to (product_path(@product) + '?sort_by=most_related') do %>
          <span class="mb-1 text-right mr-3" style="position: absolute; bottom:0; right:0;">More<i class="fas fa-chevron-right"></i></span>
        <% end %>
      </div>
    </div>
    <div class="cards-product">
      <% @product.find_related_on_tags.each_with_index do |product, index| %>
        <% if (index.even?) %>
          <div class="row">
          <% end %>
          <div class="col ml-3<%= " pr-1" if index.even? %>">
            <%= link_to product_path(product) do %>
              <%= render 'shared/product_card', bg_img_url: product.photo.attached? ? cl_image_path(product.photo.key , height: 300, width: 400, crop: :fill) : image_path("https://dummyimage.com/300x300/fff/000&text=X"), product_name: product.name, price: "¥50"%>
            <% end %>
          </div>
          <% if @product.find_related_on_tags.length.odd? && @product.find_related_on_tags.length == index + 1%>
            <div class="col p-0 m-0">
              <div class="card-category-product mx-1 invisible"></div>
            </div>
          <% end %>
          <% if (index.odd? || @product.find_related_on_tags.length == 1) %>
            </div>
          <% end %>
      <% end %>
    </div>
  <% else %>
    <!-- Product info compare -->
    <div style ="margin-right:-15px">
      <%= render 'shared/product_info_comparison', product_name: @product.name, product_name_compare: @product_compare.name, bg_img_url:@product.photo.attached? ? cl_image_path(@product.photo.key , height: 300, width: 400, crop: :fill) : image_path("https://dummyimage.com/300x300/fff/000&text=X"), bg_img_url_compare: @product_compare.photo.attached? ? cl_image_path(@product_compare.photo.key , height: 300, width: 400, crop: :fill) : image_path("https://dummyimage.com/300x300/fff/000&text=X"), rating:"4.7", rating_compare:"4.2", company_name: @product.company_name, company_name_compare: @product_compare.company_name, price: "¥100", price_compare:"¥50", ingredients: @product.ingredients, ingredients_compare: @product_compare.ingredients, size: @product.size, size_compare: @product_compare.size%>
    </div>
    <!-- product_card -->
    <div class="row" style="position: relative;">
      <div class="col-9">
        <h4 class="mb-1">Recommended for you</h4>
      </div>
      <div class="col">
        <%=  link_to (product_path(@product) + '?sort_by=most_related') do %>
          <span class="mb-1 text-right mr-3" style="position: absolute; bottom:0; right:0;">More<i class="fas fa-chevron-right"></i></span>
        <% end %>
      </div>
    </div>
    <div class="cards-product">
      <% @product.find_related_on_tags.each_with_index do |product, index| %>
        <% if (index.even?) %>
          <div class="row">
          <% end %>
          <div class="col">
            <%= link_to product_path(product) do %>
              <%= render 'shared/product_card', bg_img_url:product.photo.attached? ? cl_image_path(product.photo.key , height: 300, width: 400, crop: :fill) : image_path("https://dummyimage.com/300x300/fff/000&text=X"), product_name: product.name, price: "¥50"%>
            <% end %>
          </div>
          <% if @product.find_related_on_tags.length == 1%>
            <div class="col p-0 m-0">
              <div class="card-category-product mx-1 invisible"></div>
            </div>
          <% end %>
          <% if (index.odd? || @product.find_related_on_tags.length == 1) %>
          </div>
        <% end %>
      </div>
    </div>
    <div class="cards-product">
      <% @product.find_related_on_tags.each_with_index do |product, index| %>
        <% if (index % 2  == 0) %>
          <div class="row">
          <% end %>
          <div class="col ml-3<%= " pr-1" if index.even? %>">
            <%= link_to product_path(product) do %>
              <%= render 'shared/product_card', bg_img_url: product.photo.attached? ? cl_image_path(product.photo.key , height: 300, width: 400, crop: :fill) : image_path("https://dummyimage.com/300x300/fff/000&text=X"), product_name: product.name, price: "¥50"%>
            <% end %>
          </div>
          <% if (((index - 1) % 2  == 0 && index - 1 >= 0) || @product.find_related_on_tags.length == 1) %>
          </div>
        <% end %>
      <% end %>
    <% end %>
  </div>
<% end %>
</div>
<!-- footer -->
<%= render 'shared/footer' %>
